<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negros Island Eagles Region Members' Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script type="module">
        // const firebaseConfig = {
  apiKey: "AIzaSyAM-xOBR_Ps4LtQEfQRKRQnvCUURbt2LBE",
  authDomain: "fir-eagles-portal.firebaseapp.com",
  projectId: "fir-eagles-portal",
  storageBucket: "fir-eagles-portal.firebasestorage.app",
  messagingSenderId: "15092804787",
  appId: "1:15092804787:web:a70575aff4f9bc091c14c6"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = YOUR_FIREBASE_CONFIG_HERE;  // Paste your config here, e.g., { apiKey: "AIza...", ... }
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Data lists from PSA
        const regions = ['Western Visayas', 'Central Visayas'];
        const provinces = {
            'Western Visayas': {
                'Aklan': ['Altavas', 'Balete', 'Banga', 'Buruanga', 'Ibajay', 'Kalibo', 'Lezo', 'Madalag', 'Makato', 'Malay', 'Malinao', 'Nabas', 'New Washington', 'Numancia', 'Tangalan'],
                'Antique': ['Anini-y', 'Barbaza', 'Belison', 'Bugtong Bato', 'Caluya', 'Culasi', 'Hamtic', 'Laua-an', 'Libertad', 'Pandan', 'Patnongon', 'San Remigio', 'Sebaste', 'Sibalom', 'Tobias Fornier', 'Valderrama'],
                'Capiz': ['City of Roxas', 'Cuartero', 'Dao', 'Dumarao', 'Dumalag', 'Ivisan', 'Jamindan', 'Ma-ayon', 'Mambusao', 'Panay', 'Pilar', 'Pontevedra', 'Pres. Roxas', 'Sapian', 'Sigma'],
                'Guimaras': ['Buenavista', 'Jordan', 'Nueva Valencia', 'San Lorenzo', 'Sibunag'],
                'Iloilo': ['Ajuy', 'Alimodian', 'Anilao', 'Badiangan', 'Balasan', 'Banate', 'Barotac Nuevo', 'Barotac Viejo', 'Batad', 'Bingawan', 'Cabatuan', 'Calinog', 'Carles', 'Concepcion', 'Dingle', 'Duenas', 'Dumangas', 'Estancia', 'Guimbal', 'Igbaras', 'Janiuay', 'Lambunao', 'Leganes', 'Lemery', 'Leon', 'Maasin', 'Miagao', 'Mina', 'New Lucena', 'Oton', 'Pavia', 'Pototan', 'San Dionisio', 'San Enrique', 'San Joaquin', 'San Miguel', 'San Rafael', 'Santa Barbara', 'Sara', 'Tigbauan', 'Tubungan', 'Zarraga'],
                'Negros Occidental': ['Bacolod', 'Bago', 'Cadiz', 'Escalante', 'Himamaylan', 'Kabankalan', 'La Carlota', 'Sagay', 'San Carlos', 'Silay', 'Sipalay', 'Talisay', 'Victorias', 'Binalbagan', 'Calatrava', 'Candoni', 'Cauayan', 'Don Salvador Benedicto', 'Enrique B. Magalona', 'Hinigaran', 'Hinoba-an', 'Ilog', 'Isabela', 'La Castellana', 'Manapla', 'Moises Padilla', 'Murcia', 'Pontevedra', 'Pulupandan', 'San Enrique', 'Toboso', 'Valladolid']
            },
            'Central Visayas': {
                'Bohol': ['Alicia', 'Anda', 'Antequera', 'Baclayon', 'Balilihan', 'Batuan', 'Bilar', 'Buenavista', 'Calape', 'Candijay', 'Carmen', 'Catigbian', 'Clarin', 'Corella', 'Cortes', 'Dauis', 'Dimiao', 'Duero', 'Garcia Hernandez', 'Guindulman', 'Inabanga', 'Jagna', 'Lila', 'Loay', 'Loboc', 'Loon', 'Mabini', 'Maribojoc', 'Panglao', 'Pilar', 'President Carlos P. Garcia', 'Sagbayan', 'San Isidro', 'Sebmo', 'Sierra Bullones', 'Sikatuna', 'Tagbilaran City', 'Talibon', 'Trinidad', 'Ubay', 'Valencia'],
                'Cebu': ['Alcantara', 'Alcoy', 'Alegria', 'Amlan', 'Badian', 'Balamban', 'Bantayan', 'Barili', 'Bogo', 'Borbon', 'Carcar', 'Catmon', 'Compostela', 'Consolacion', 'Cordoba', 'Daanbantayan', 'Dalaguete', 'Danao', 'Dumanjug', 'Ginatilan', 'Liloan', 'Madridejos', 'Malabuyoc', 'Medellin', 'Minglanilla', 'Moalboal', 'Naga', 'Oslob', 'Pilar', 'Pinamungajan', 'San Fernando', 'San Francisco', 'San Remigio', 'Santa Fe', 'Santander', 'Sibonga', 'Sogod', 'Tabogon', 'Tabuelan', 'Toledo City', 'Tuburan'],
                'Negros Oriental': ['Ayungon', 'Bacong', 'Basay', 'Bayawan', 'Bindoy', 'Canlaon', 'Dumaguete', 'Guihulngan', 'Jimalalud', 'La Libertad', 'Mabinay', 'Manjuyod', 'Pamplona', 'San Jose', 'Tanjay', 'Tayasan', 'Valencia', 'Vallehermoso'],
                'Siquijor': ['Enrique Villanueva', 'Larena', 'Lazi', 'Maria', 'San Juan', 'Siquijor']
            }
        };
        const clubs = ['Masskara Eagles Club', 'Masskara Central Eagles Club', 'Murcia Tinabuay Eagles Club', 'Masskara Yuhom Eagles Club', 'Talisay Halangdon Eagles Club', 'Isla del Fuego Eagles Club', 'Masskara Buklod Eagles Club'];
        const sexes = ['Male', 'Female', 'Other'];
        const bloodTypes = ['A+', 'A-', 'B+', 'B-', 'AB+', 'AB-', 'O+', 'O-'];
        const industries = ['Electronics & Semiconductors', 'Food & Beverage Processing', 'Chemicals & Petrochemicals', 'Automotive & Transport', 'Aerospace', 'IT-BPM (Business Process Management)', 'Tourism & Hospitality', 'Construction', 'Real Estate', 'E-Commerce', 'Agriculture', 'General Manufacturing'];

        // App logic starts here
        let currentUser = null;
        let localData = JSON.parse(localStorage.getItem('profileData') || '{}');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('profilePage').style.display = 'block';
                loadLocalData();
            } else {
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('profilePage').style.display = 'none';
            }
        });

        function populateDropdown(parent, options) {
            const select = document.createElement('select');
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
            parent.appendChild(select);
            return select;
        }

        function chainDropdowns(regionSelect, provinceSelect, citySelect) {
            regionSelect.onchange = () => {
                const region = regionSelect.value;
                provinceSelect.innerHTML = '<option>Select Province</option>';
                citySelect.innerHTML = '<option>Select City/Municipality</option>';
                if (region && provinces[region]) {
                    Object.keys(provinces[region]).forEach(prov => {
                        const option = document.createElement('option');
                        option.value = prov;
                        option.textContent = prov;
                        provinceSelect.appendChild(option);
                    });
                }
            };
            provinceSelect.onchange = () => {
                const region = regionSelect.value;
                const prov = provinceSelect.value;
                citySelect.innerHTML = '<option>Select City/Municipality</option>';
                if (region && prov && provinces[region][prov]) {
                    provinces[region][prov].forEach(city => {
                        const option = document.createElement('option');
                        option.value = city;
                        option.textContent = city;
                        citySelect.appendChild(option);
                    });
                }
            };
        }

        function loadLocalData() {
            // Load saved data into form
            const form = document.getElementById('profileForm');
            for (let [key, value] of Object.entries(localData)) {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) input.value = value;
            }
            // For photo, show preview if URL saved
            if (localData.photoUrl) {
                document.getElementById('photoPreview').src = localData.photoUrl;
            }
        }

        function saveLocal() {
            const form = document.getElementById('profileForm');
            const formData = new FormData(form);
            localData = Object.fromEntries(formData);
            localStorage.setItem('profileData', JSON.stringify(localData));
            alert('Saved locally! You can continue later.');
        }

        async function submitToDB() {
            const form = document.getElementById('profileForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            const certify = document.getElementById('certify').checked;

            // Check required fields (all except dependents)
            const required = ['clubMembership', 'lastName', 'firstName', 'middleName', 'dob', 'sex', 'bloodType', 'birthRegion', 'birthProvince', 'birthCity', 'homeRegion', 'homeProvince', 'homeCity', 'barangay', 'street', 'email', 'fbName', 'employerName', 'employerAddress', 'position', 'industry', 'sponsorName', 'yearJoined', 'photoFile'];
            let missing = [];
            required.forEach(field => {
                if (!data[field] && field !== 'photoFile') missing.push(field);
            });
            if (missing.length > 0 || !certify) {
                alert(`Please fill all required fields and certify. Missing: ${missing.join(', ')}`);
                return;
            }

            // Upload photo if new
            let photoUrl = localData.photoUrl || '';
            if (data.photoFile && data.photoFile.size > 0) {
                const photoRef = ref(storage, `photos/${currentUser.uid}`);
                await uploadBytes(photoRef, data.photoFile);
                photoUrl = await getDownloadURL(photoRef);
            }

            // Save to DB (exclude dependents if empty)
            const memberData = { ...data, uid: currentUser.uid, photoUrl, timestamp: new Date() };
            if (!memberData.spouse && !memberData.child1 && !memberData.child2 && !memberData.child3) {
                delete memberData.spouse; delete memberData.spouseDob; delete memberData.child1; delete memberData.child1Dob;
                // ... similarly for child2/3
            }
            await addDoc(collection(db, 'members'), memberData);
            localStorage.removeItem('profileData'); // Clear local after submit
            alert('Submitted successfully! Thank you.');
        }

        async function searchDB() {
            const criteria = {
                club: document.getElementById('searchClub').value,
                lastName: document.getElementById('searchLastName').value,
                // Add more as needed
            };
            let q = query(collection(db, 'members'));
            if (criteria.club) q = query(q, where('clubMembership', '==', criteria.club));
            if (criteria.lastName) q = query(q, where('lastName', '==', criteria.lastName));
            const snapshot = await getDocs(q);
            let results = '<table class="table"><tr><th>Name</th><th>Club</th><th>Province</th></tr>';
            snapshot.forEach(doc => {
                const d = doc.data();
                results += `<tr><td>${d.firstName} ${d.lastName}</td><td>${d.clubMembership}</td><td>${d.homeProvince}</td></tr>`;
            });
            results += '</table>';
            document.getElementById('searchResults').innerHTML = results || '<p>No results found.</p>';
        }

        // Login/Register functions
        async function register() {
            const username = document.getElementById('username').value; // Treated as mobile
            const password = document.getElementById('password').value;
            const email = `${username}@eagles.local`; // Fake email for auth, real mobile in DB
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                alert('Registered! Logging in...');
            } catch (e) { alert('Error: ' + e.message); }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = `${username}@eagles.local`;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (e) { alert('Login failed: ' + e.message); }
        }

        function logout() {
            signOut(auth);
        }

        // Photo handling
        document.getElementById('takePhoto').onclick = () => {
            navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                // Simple capture - in real, add canvas to snap
                alert('Camera opened! Take photo in browser (mobile works best). Upload the file next.');
                stream.getTracks().forEach(track => track.stop());
            });
        };

        document.getElementById('uploadPhoto').onclick = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = e => {
                const file = e.target.files[0];
                document.getElementById('photoFile').files = e.target.files;
                const reader = new FileReader();
                reader.onload = ev => document.getElementById('photoPreview').src = ev.target.result;
                reader.readAsDataURL(file);
            };
            input.click();
        };

        // Initialize form on load
        window.onload = () => {
            // Build form dynamically
            const form = document.getElementById('profileForm');
            // Club
            const clubDiv = document.createElement('div');
            clubDiv.className = 'mb-3';
            clubDiv.innerHTML = '<label>Club Membership</label>';
            populateDropdown(clubDiv, clubs);
            form.appendChild(clubDiv);

            // Personal Data
            ['lastName', 'firstName', 'middleName'].forEach(field => {
                const div = document.createElement('div');
                div.className = 'mb-3';
                div.innerHTML = `<label>${field.replace(/([A-Z])/g, ' $1').toUpperCase()}</label><input type="text" class="form-control" name="${field}">`;
                form.appendChild(div);
            });
            const dobDiv = document.createElement('div');
            dobDiv.className = 'mb-3';
            dobDiv.innerHTML = '<label>Date of Birth</label><input type="date" class="form-control" name="dob">';
            form.appendChild(dobDiv);
            const sexDiv = document.createElement('div');
            sexDiv.className = 'mb-3';
            sexDiv.innerHTML = '<label>Sex</label>';
            populateDropdown(sexDiv, sexes);
            form.appendChild(sexDiv);
            const bloodDiv = document.createElement('div');
            bloodDiv.className = 'mb-3';
            bloodDiv.innerHTML = '<label>Blood Type</label>';
            populateDropdown(bloodDiv, bloodTypes);
            form.appendChild(bloodDiv);

            // Place of Birth
            const birthDiv = document.createElement('div');
            birthDiv.className = 'row';
            ['Region', 'Province', 'City/Municipality'].forEach((label, i) => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                col.innerHTML = `<label>Birth ${label}</label>`;
                const select = document.createElement('select');
                select.className = 'form-control';
                select.name = `birth${label.toLowerCase().replace(' ', '')}`;
                col.appendChild(select);
                birthDiv.appendChild(col);
            });
            const birthRegion = form.querySelector('[name="birthregion"]');
            const birthProvince = form.querySelector('[name="birthprovince"]');
            const birthCity = form.querySelector('[name="birthcity"]');
            populateDropdown(birthRegion, regions);
            chainDropdowns(birthRegion, birthProvince, birthCity);
            form.appendChild(birthDiv);

            // Home Address (similar to birth)
            const homeDiv = document.createElement('div');
            homeDiv.className = 'row';
            ['Region', 'Province', 'City/Municipality'].forEach((label, i) => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                col.innerHTML = `<label>Home ${label}</label>`;
                const select = document.createElement('select');
                select.className = 'form-control';
                select.name = `home${label.toLowerCase().replace(' ', '')}`;
                col.appendChild(select);
                homeDiv.appendChild(col);
            });
            const homeRegion = form.querySelector('[name="homeregion"]');
            const homeProvince = form.querySelector('[name="homeprovince"]');
            const homeCity = form.querySelector('[name="homecity"]');
            populateDropdown(homeRegion, regions);
            chainDropdowns(homeRegion, homeProvince, homeCity);
            form.appendChild(homeDiv);

            const addrDiv = document.createElement('div');
            addrDiv.className = 'row';
            ['barangay', 'street'].forEach(field => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                col.innerHTML = `<label>${field.toUpperCase()}</label><input type="text" class="form-control" name="${field}">`;
                addrDiv.appendChild(col);
            });
            form.appendChild(addrDiv);

            // Contact
            const mobileDiv = document.createElement('div');
            mobileDiv.className = 'mb-3';
            mobileDiv.innerHTML = `<label>Mobile No.</label><input type="text" class="form-control" name="mobile" value="${localStorage.getItem('mobile') || ''}" readonly>`;
            form.appendChild(mobileDiv);
            const contactDiv = document.createElement('div');
            contactDiv.className = 'row';
            ['email', 'fbName'].forEach(field => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                col.innerHTML = `<label>${field.toUpperCase().replace('ad', ' Address')}</label><input type="text" class="form-control" name="${field}">`;
                contactDiv.appendChild(col);
            });
            form.appendChild(contactDiv);

            // Employment
            const empDiv = document.createElement('div');
            empDiv.className = 'row';
            ['employerName', 'employerAddress', 'position'].forEach(field => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                col.innerHTML = `<label>${field.replace('employer', '').toUpperCase()}</label><input type="text" class="form-control" name="${field}">`;
                empDiv.appendChild(col);
            });
            form.appendChild(empDiv);
            const indDiv = document.createElement('div');
            indDiv.className = 'mb-3';
            indDiv.innerHTML = '<label>Industry Category</label>';
            populateDropdown(indDiv, industries);
            form.appendChild(indDiv);

            // Legal Dependents (optional)
            const depDiv = document.createElement('div');
            depDiv.className = 'row';
            [['spouse', 'Spouse'], ['spouseDob', "Spouse's Birthday"], ['child1', 'Child 1'], ['child1Dob', 'Child 1 Birthday'], ['child2', 'Child 2'], ['child2Dob', 'Child 2 Birthday'], ['child3', 'Child 3'], ['child3Dob', 'Child 3 Birthday']].forEach(([field, label]) => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                const type = field.includes('Dob') ? 'date' : 'text';
                col.innerHTML = `<label>${label}</label><input type="${type}" class="form-control" name="${field}">`;
                depDiv.appendChild(col);
            });
            form.appendChild(depDiv);

            // Sponsored By
            const sponDiv = document.createElement('div');
            sponDiv.className = 'row';
            ['sponsorName', 'yearJoined'].forEach(field => {
                const col = document.createElement('div');
                col.className = 'col mb-3';
                const type = field === 'yearJoined' ? 'number' : 'text';
                col.innerHTML = `<label>${field.toUpperCase()}</label><input type="${type}" class="form-control" name="${field}">`;
                sponDiv.appendChild(col);
            });
            form.appendChild(sponDiv);

            // Photo
            const photoDiv = document.createElement('div');
            photoDiv.className = 'mb-3';
            photoDiv.innerHTML = `
                <label>Photo</label>
                <button type="button" id="takePhoto" class="btn btn-secondary me-2">Take Picture</button>
                <button type="button" id="uploadPhoto" class="btn btn-secondary">Upload from File</button>
                <input type="file" id="photoFile" name="photoFile" style="display:none">
                <img id="photoPreview" style="max-width:200px; margin-top:10px;" alt="Preview">
            `;
            form.appendChild(photoDiv);

            // Save buttons
            const saveDiv = document.createElement('div');
            saveDiv.innerHTML = `
                <button type="button" onclick="saveLocal()" class="btn btn-warning me-2">Save and Continue Later</button>
                <div class="form-check mb-2">
                    <input type="checkbox" id="certify" class="form-check-input">
                    <label class="form-check-label">I certify that all information is true and accurate</label>
                </div>
                <button type="button" onclick="submitToDB()" class="btn btn-success">Save and Submit</button>
            `;
            form.appendChild(saveDiv);

            // Search Tab
            const searchDiv = document.createElement('div');
            searchDiv.id = 'searchTab';
            searchDiv.className = 'mt-5 p-3 border-top';
            searchDiv.innerHTML = `
                <h5>Search Members</h5>
                <div class="row">
                    <div class="col"><select id="searchClub" class="form-control"><option>Select Club</option>${clubs.map(c => `<option>${c}</option>`).join('')}</select></div>
                    <div class="col"><input id="searchLastName" placeholder="Last Name" class="form-control"></div>
                    <div class="col"><button onclick="searchDB()" class="btn btn-primary">Search</button></div>
                </div>
                <div id="searchResults"></div>
            `;
            form.parentNode.appendChild(searchDiv);

            // Logout
            const logoutDiv = document.createElement('div');
            logoutDiv.className = 'mt-3';
            logoutDiv.innerHTML = '<button onclick="logout()" class="btn btn-outline-danger">Logout</button>';
            form.parentNode.appendChild(logoutDiv);
        };
    </script>
</head>
<body>
    <div id="loginPage" class="container mt-5">
        <h1 class="text-center">Negros Island Eagles Region Members' Portal</h1>
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="mb-3"><input id="username" type="text" class="form-control" placeholder="Username (Mobile No.)" required></div>
                <div class="mb-3"><input id="password" type="password" class="form-control" placeholder="Password" required></div>
                <div class="d-grid gap-2">
                    <button onclick="register()" class="btn btn-primary">Register</button>
                    <button onclick="login()" class="btn btn-success">Log In</button>
                </div>
            </div>
        </div>
    </div>
    <div id="profilePage" class="container mt-5" style="display:none;">
        <h2>Member Profile</h2>
        <form id="profileForm"></form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>