<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Negros Island Eagles Region Members' Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; }
    .card { max-width:420px; margin:auto; }
    #photoPreview { max-height:180px; margin-top:8px; }
  </style>
</head>
<body>

  <!-- ========= LOGIN PAGE ========= -->
  <div id="loginPage" class="container mt-5">
    <h1 class="text-center mb-4">Negros Island Eagles Region<br>Members' Portal</h1>
    <div class="card p-4 shadow">
      <div class="mb-3">
        <label class="form-label">Username (any text, e.g. mobile no.)</label>
        <input id="username" type="text" class="form-control" placeholder="09171234567" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Password</label>
        <input id="password" type="password" class="form-control" placeholder="min 6 characters" required>
      </div>
      <div class="d-grid gap-2">
        <button onclick="register()" class="btn btn-primary">Register</button>
        <button onclick="login()" class="btn btn-success">Log In</button>
      </div>
    </div>
  </div>

  <!-- ========= PROFILE PAGE ========= -->
  <div id="profilePage" class="container mt-4" style="display:none;">
    <h2 class="mb-4">Member Profile</h2>
    <form id="profileForm" class="row g-3"></form>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // ==== 1. PASTE YOUR FIREBASE CONFIG HERE ====
    const firebaseConfig = {
  apiKey: "AIzaSyAM-xOBR_Ps4LtQEfQRKRQnvCUURbt2LBE",
  authDomain: "fir-eagles-portal.firebaseapp.com",
  projectId: "fir-eagles-portal",
  storageBucket: "fir-eagles-portal.firebasestorage.app",
  messagingSenderId: "15092804787",
  appId: "1:15092804787:web:a70575aff4f9bc091c14c6"
};
    // ============================================

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-storage.js';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- DATA LISTS (same as before) ----------
    const clubs = ['Masskara Eagles Club','Masskara Central Eagles Club','Murcia Tinabuay Eagles Club','Masskara Yuhom Eagles Club','Talisay Halangdon Eagles Club','Isla del Fuego Eagles Club','Masskara Buklod Eagles Club'];
    const sexes = ['Male','Female','Other'];
    const bloodTypes = ['A+','A-','B+','B-','AB+','AB-','O+','O-'];
    const industries = ['Electronics & Semiconductors','Food & Beverage','Chemicals','Automotive','Aerospace','IT-BPM','Tourism','Construction','Real Estate','E-Commerce','Agriculture','Manufacturing'];

    const regions = ['Western Visayas','Central Visayas'];
    const provinces = {
      'Western Visayas': {
        'Aklan': ['Altavas','Balete','Banga','Buruanga','Ibajay','Kalibo','Lezo','Madalag','Makato','Malay','Malinao','Nabas','New Washington','Numancia','Tangalan'],
        'Antique': ['Anini-y','Barbaza','Belison','Bugtong Bato','Caluya','Culasi','Hamtic','Laua-an','Libertad','Pandan','Patnongon','San Remigio','Sebaste','Sibalom','Tobias Fornier','Valderrama'],
        'Capiz': ['City of Roxas','Cuartero','Dao','Dumarao','Dumalag','Ivisan','Jamindan','Ma-ayon','Mambusao','Panay','Pilar','Pontevedra','Pres. Roxas','Sapian','Sigma'],
        'Guimaras': ['Buenavista','Jordan','Nueva Valencia','San Lorenzo','Sibunag'],
        'Iloilo': ['Ajuy','Alimodian','Anilao','Badiangan','Balasan','Banate','Barotac Nuevo','Barotac Viejo','Batad','Bingawan','Cabatuan','Calinog','Carles','Concepcion','Dingle','Duenas','Dumangas','Estancia','Guimbal','Igbaras','Janiuay','Lambunao','Leganes','Lemery','Leon','Maasin','Miagao','Mina','New Lucena','Oton','Pavia','Pototan','San Dionisio','San Enrique','San Joaquin','San Miguel','San Rafael','Santa Barbara','Sara','Tigbauan','Tubungan','Zarraga'],
        'Negros Occidental': ['Bacolod','Bago','Cadiz','Escalante','Himamaylan','Kabankalan','La Carlota','Sagay','San Carlos','Silay','Sipalay','Talisay','Victorias','Binalbagan','Calatrava','Candoni','Cauayan','Don Salvador Benedicto','Enrique B. Magalona','Hinigaran','Hinoba-an','Ilog','Isabela','La Castellana','Manapla','Moises Padilla','Murcia','Pontevedra','Pulupandan','San Enrique','Toboso','Valladolid']
      },
      'Central Visayas':{
        'Bohol':['Alicia','Anda','Antequera','Baclayon','Balilihan','Batuan','Bilar','Buenavista','Calape','Candijay','Carmen','Catigbian','Clarin','Corella','Cortes','Dauis','Dimiao','Duero','Garcia Hernandez','Guindulman','Inabanga','Jagna','Lila','Loay','Loboc','Loon','Mabini','Maribojoc','Panglao','Pilar','President Carlos P. Garcia','Sagbayan','San Isidro','Sebmo','Sierra Bullones','Sikatuna','Tagbilaran City','Talibon','Trinidad','Ubay','Valencia'],
        'Cebu':['Alcantara','Alcoy','Alegria','Amlan','Badian','Balamban','Bantayan','Barili','Bogo','Borbon','Carcar','Catmon','Compostela','Consolacion','Cordoba','Daanbantayan','Dalaguete','Danao','Dumanjug','Ginatilan','Liloan','Madridejos','Malabuyoc','Medellin','Minglanilla','Moalboal','Naga','Oslob','Pilar','Pinamungajan','San Fernando','San Francisco','San Remigio','Santa Fe','Santander','Sibonga','Sogod','Tabogon','Tabuelan','Toledo City','Tuburan'],
        'Negros Oriental':['Ayungon','Bacong','Basay','Bayawan','Bindoy','Canlaon','Dumaguete','Guihulngan','Jimalalud','La Libertad','Mabinay','Manjuyod','Pamplona','San Jose','Tanjay','Tayasan','Valencia','Vallehermoso'],
        'Siquijor':['Enrique Villanueva','Larena','Lazi','Maria','San Juan','Siquijor']
      }
    };

    // ---------- AUTH LISTENER (FIXED) ----------
    onAuthStateChanged(auth, user => {
      const loginDiv = document.getElementById('loginPage');
      const profileDiv = document.getElementById('profilePage');

      if (user) {
        // USER IS LOGGED IN → show profile
        loginDiv.style.display = 'none';
        profileDiv.style.display = 'block';
        loadLocalData();
        // Show username in mobile field (read-only)
        document.getElementById('mobile').value = user.email.split('@')[0];
      } else {
        // NO USER → force login page
        loginDiv.style.display = 'block';
        profileDiv.style.display = 'none';
      }
    });

    // ---------- REGISTER ----------
    window.register = async () => {
      const username = document.getElementById('username').value.trim();
      const pwd = document.getElementById('password').value;
      if (!username || !pwd) return alert('Enter username and password');
      const fakeEmail = `${username}@eagles.local`; // hidden from user
      try {
        await createUserWithEmailAndPassword(auth, fakeEmail, pwd);
        alert('Registered! You are now logged in.');
      } catch (e) { alert('Register error: ' + e.message); }
    };

    // ---------- LOGIN ----------
    window.login = async () => {
      const username = document.getElementById('username').value.trim();
      const pwd = document.getElementById('password').value;
      if (!username || !pwd) return alert('Enter username and password');
      const fakeEmail = `${username}@eagles.local`;
      try {
        await signInWithEmailAndPassword(auth, fakeEmail, pwd);
      } catch (e) { alert('Login error: ' + e.message); }
    };

    // ---------- LOCAL SAVE ----------
    const localKey = 'eaglesProfile';
    const saveLocal = () => {
      const data = Object.fromEntries(new FormData(document.getElementById('profileForm')));
      localStorage.setItem(localKey, JSON.stringify(data));
      alert('Saved locally – continue anytime.');
    };
    const loadLocalData = () => {
      const saved = JSON.parse(localStorage.getItem(localKey) || '{}');
      const form = document.getElementById('profileForm');
      Object.entries(saved).forEach(([k,v]) => {
        const el = form.elements[k];
        if (el) el.value = v;
      });
      if (saved.photoUrl) document.getElementById('photoPreview').src = saved.photoUrl;
    };

    // ---------- SUBMIT ----------
    const requiredFields = ['clubMembership','lastName','firstName','middleName','dob','sex','bloodType',
      'birthRegion','birthProvince','birthCity','homeRegion','homeProvince','homeCity','barangay','street',
      'mobile','emailContact','fbName','employerName','employerAddress','position','industry',
      'sponsorName','yearJoined'];

    window.submitToDB = async () => {
      if (!document.getElementById('certify').checked) return alert('You must certify the data.');
      const form = document.getElementById('profileForm');
      const data = Object.fromEntries(new FormData(form));

      const missing = requiredFields.filter(f => !data[f]);
      if (missing.length) return alert('Missing: ' + missing.join(', '));

      let photoUrl = localStorage.getItem('photoUrl') || '';
      const photoFile = document.getElementById('photoFile').files[0];
      if (photoFile) {
        const storRef = ref(storage, `photos/${auth.currentUser.uid}`);
        await uploadBytes(storRef, photoFile);
        photoUrl = await getDownloadURL(storRef);
      }

      const member = { ...data, uid: auth.currentUser.uid, photoUrl, submittedAt: new Date() };
      await addDoc(collection(db, 'members'), member);
      localStorage.removeItem(localKey);
      localStorage.removeItem('photoUrl');
      alert('Submitted successfully!');
    };

    // ---------- SEARCH ----------
    window.searchDB = async () => {
      const club = document.getElementById('searchClub').value;
      const last = document.getElementById('searchLastName').value.trim();
      let q = collection(db, 'members');
      if (club) q = query(q, where('clubMembership','==',club));
      if (last) q = query(q, where('lastName','==',last));
      const snap = await getDocs(q);
      const tbl = document.getElementById('searchResults');
      if (snap.empty) { tbl.innerHTML = '<p>No results.</p>'; return; }
      let html = '<table class="table table-sm"><thead><tr><th>Name</th><th>Club</th><th>City</th></tr></thead><tbody>';
      snap.forEach(d => {
        const r = d.data();
        html += `<tr><td>${r.firstName} ${r.lastName}</td><td>${r.clubMembership}</td><td>${r.homeCity}</td></tr>`;
      });
      html += '</tbody></table>';
      tbl.innerHTML = html;
    };

    // ---------- BUILD FORM ----------
    window.onload = () => {
      const f = document.getElementById('profileForm');

      const div = (label, name, type='text', extra='') => {
        const d = document.createElement('div'); d.className='col-md-6';
        d.innerHTML = `<label class="form-label">${label}</label><input type="${type}" class="form-control" name="${name}" ${extra}>`;
        return d;
      };
      const sel = (label, name, opts) => {
        const d = document.createElement('div'); d.className='col-md-6';
        let ops = '<option value="">--</option>';
        opts.forEach(o=>ops+=`<option>${o}</option>`);
        d.innerHTML = `<label class="form-label">${label}</label><select class="form-select" name="${name}">${ops}</select>`;
        return d;
      };

      // Club
      f.appendChild(sel('Club Membership','clubMembership',clubs));

      // Personal
      ['lastName','firstName','middleName'].forEach(n=>f.appendChild(div(n.charAt(0).toUpperCase()+n.slice(1),n)));
      f.appendChild(div('Date of Birth','dob','date'));
      f.appendChild(sel('Sex','sex',sexes));
      f.appendChild(sel('Blood Type','bloodType',bloodTypes));

      // Birth place
      const birth = document.createElement('div'); birth.className='row';
      const bReg = sel('Birth Region','birthRegion',regions);
      const bProv = document.createElement('div'); bProv.className='col-md-6';
      bProv.innerHTML = '<label class="form-label">Birth Province</label><select class="form-select" name="birthProvince"><option>--</option></select>';
      const bCity = document.createElement('div'); bCity.className='col-md-6';
      bCity.innerHTML = '<label class="form-label">Birth City/Municipality</label><select class="form-select" name="birthCity"><option>--</option></select>';
      birth.append(bReg, bProv, bCity);
      f.appendChild(birth);

      // Home address
      const home = document.createElement('div'); home.className='row';
      const hReg = sel('Home Region','homeRegion',regions);
      const hProv = document.createElement('div'); hProv.className='col-md-6';
      hProv.innerHTML = '<label class="form-label">Home Province</label><select class="form-select" name="homeProvince"><option>--</option></select>';
      const hCity = document.createElement('div'); hCity.className='col-md-6';
      hCity.innerHTML = '<label class="form-label">Home City/Municipality</label><select class="form-select" name="homeCity"><option>--</option></select>';
      home.append(hReg, hProv, hCity);
      f.appendChild(home);

      f.appendChild(div('Barangay','barangay'));
      f.appendChild(div('Street','street'));

      // Contact
      f.appendChild(div('Mobile No.','mobile','tel','readonly')); // filled from username
      f.appendChild(div('Email (contact)','emailContact','email'));
      f.appendChild(div('FB/Messenger Name','fbName'));

      // Employment
      f.appendChild(div('Employer / Business','employerName'));
      f.appendChild(div('Employer Address','employerAddress'));
      f.appendChild(div('Position','position'));
      f.appendChild(sel('Industry','industry',industries));

      // Dependents
      const dep = document.createElement('div'); dep.className='row';
      ['spouse','spouseDob','child1','child1Dob','child2','child2Dob','child3','child3Dob'].forEach((n,i)=>{
        const label = i%2===0 ? n.replace(/([a-z])([A-Z])/g,'$1 $2') : n.replace('Dob','Birthday');
        dep.appendChild(div(label,n, i%2===1?'date':'text'));
      });
      f.appendChild(dep);

      // Sponsor
      f.appendChild(div('Sponsor Name','sponsorName'));
      f.appendChild(div('Year Joined','yearJoined','number'));

      // Photo
      const photoDiv = document.createElement('div'); photoDiv.className='col-12';
      photoDiv.innerHTML = `
        <label class="form-label">Photo</label><br>
        <button type="button" id="takePhoto" class="btn btn-sm btn-outline-secondary">Take Picture</button>
        <button type="button" id="uploadPhoto" class="btn btn-sm btn-outline-secondary">Upload File</button>
        <input type="file" id="photoFile" accept="image/*" style="display:none">
        <img id="photoPreview" class="img-thumbnail mt-2" style="max-height:180px;display:none;">
      `;
      f.appendChild(photoDiv);

      // Buttons
      const btns = document.createElement('div'); btns.className='col-12 d-flex flex-wrap gap-2';
      btns.innerHTML = `
        <button type="button" onclick="saveLocal()" class="btn btn-warning">Save & Continue Later</button>
        <div class="form-check mt-2">
          <input type="checkbox" id="certify" class="form-check-input">
          <label class="form-check-label">I certify all information is true</label>
        </div>
        <button type="button" onclick="submitToDB()" class="btn btn-success">Save & Submit</button>
        <button type="button" onclick="signOut(auth).then(()=>location.reload())" class="btn btn-outline-danger ms-auto">Logout</button>
      `;
      f.appendChild(btns);

      // Chain dropdowns
      const chain = (regSel, provSel, citySel) => {
        regSel.onchange = () => {
          const r = regSel.value;
          provSel.innerHTML = '<option>--</option>';
          citySel.innerHTML = '<option>--</option>';
          if (!r) return;
          Object.keys(provinces[r]).forEach(p=>{
            const o = document.createElement('option'); o.value=p; o.text=p;
            provSel.appendChild(o);
          });
        };
        provSel.onchange = () => {
          const r = regSel.value, p = provSel.value;
          citySel.innerHTML = '<option>--</option>';
          if (!p) return;
          provinces[r][p].forEach(c=>{
            const o = document.createElement('option'); o.value=c; o.text=c;
            citySel.appendChild(o);
          });
        };
      };
      chain(f.birthRegion, f.birthProvince, f.birthCity);
      chain(f.homeRegion, f.homeProvince, f.homeCity);

      // Photo handlers
      document.getElementById('takePhoto').onclick = () => {
        const inp = document.createElement('input'); inp.type='file'; inp.accept='image/*'; inp.capture='environment';
        inp.onchange = e => handlePhoto(e.target.files[0]);
        inp.click();
      };
      document.getElementById('uploadPhoto').onclick = () => document.getElementById('photoFile').click();
      document.getElementById('photoFile').onchange = e => handlePhoto(e.target.files[0]);
      const handlePhoto = file => {
        if (!file) return;
        const prev = document.getElementById('photoPreview');
        prev.src = URL.createObjectURL(file); prev.style.display='block';
        localStorage.setItem('photoUrl', prev.src);
      };

      // Search tab
      const searchDiv = document.createElement('div'); searchDiv.className='mt-5 p-3 border-top';
      searchDiv.innerHTML = `
        <h5>Search Members</h5>
        <div class="row g-2">
          <div class="col"><select id="searchClub" class="form-select"><option value="">All Clubs</option>${clubs.map(c=>`<option>${c}</option>`).join('')}</select></div>
          <div class="col"><input id="searchLastName" placeholder="Last Name" class="form-control"></div>
          <div class="col-auto"><button onclick="searchDB()" class="btn btn-primary">Search</button></div>
        </div>
        <div id="searchResults" class="mt-3"></div>
      `;
      document.getElementById('profilePage').appendChild(searchDiv);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>